<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Leaderboard Widget</title>
<style>
  :root{
    --bg:#0b0f14; --fg:#e9eef5; --muted:#9fb0c3; --accent:#4ea1ff; --card:#121822; --chip:#1b2431; --border:#233143;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .pill{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .tools{margin-left:auto;display:flex;gap:8px}
  .search{background:var(--card);border:1px solid var(--border);color:var(--fg);padding:8px 10px;border-radius:8px;outline:none}
  .table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);font-size:14px}
  th{background:#0f1622;position:sticky;top:0;z-index:1;cursor:pointer;user-select:none}
  tr:hover td{background:#0e141e}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .foot{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-top:10px}
  .btn{background:var(--chip);color:var(--fg);border:1px solid var(--border);padding:6px 10px;border-radius:8px;cursor:pointer}
  .spinner{display:inline-block;width:18px;height:18px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .err{color:#ff8a8a}
  .note{color:var(--muted);font-size:12px;margin-top:6px}
  @media (max-width:700px){ th,td{padding:8px} .tools{width:100%;justify-content:space-between} }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1 id="title">Leaderboard</h1>
    <span class="pill" id="meta">lädt…</span>
    <div class="tools">
      <input id="search" class="search" placeholder="Suchen… (⌘/Ctrl+K)" />
      <button id="dl" class="btn" title="Gefilterte Ansicht als CSV herunterladen">CSV</button>
    </div>
  </div>

  <div id="status" class="note"><span class="spinner"></span>Daten werden geladen…</div>
  <table id="tbl" class="table" hidden>
    <thead><tr id="thead"></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="foot" id="foot" hidden>
    <div id="count"></div>
    <div id="sortnote" class="note"></div>
  </div>
</div>

<script>
// ------- Helper: URL-Params lesen -------
const params = new URLSearchParams(location.search);
const dataURL = params.get('data'); // required
const columnsParam = params.get('columns'); // "col1,col2,col3"
const sortParam = params.get('sort');       // "score:desc" / "name:asc"
const titleParam = params.get('title') || 'Leaderboard';
const topN = parseInt(params.get('top')) || null;
const theme = params.get('theme') || 'dark'; // future: light
const compact = params.get('compact') === '1';
const typeParam = params.get('type'); // "csv" | "json" | null (auto)
const filterQuestionIds = (params.get('questionIds')||'').split(',').map(s=>s.trim()).filter(Boolean); // optional

document.getElementById('title').textContent = titleParam;

// ------- Fallbacks & Guards -------
const statusEl = document.getElementById('status');
const metaEl = document.getElementById('meta');
const tableEl = document.getElementById('tbl');
const theadEl = document.getElementById('thead');
const tbodyEl = document.getElementById('tbody');
const footEl = document.getElementById('foot');
const countEl = document.getElementById('count');
const sortnoteEl = document.getElementById('sortnote');
const searchEl = document.getElementById('search');
const dlBtn = document.getElementById('dl');

if (!dataURL) {
  statusEl.innerHTML = '<span class="err">Fehler:</span> Kein <code>?data=</code>-Parameter angegeben.';
  throw new Error('No data param');
}

// ------- CSV Parser (leichtgewichtig) -------
function parseCSV(text) {
  // einfacher Parser (keine komplexen eingebetteten Quotes). Für volle Robustheit nutze type=csv&parser=papaparse.
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
  const headers = lines.shift().split(',').map(h=>h.trim());
  const rows = lines.map(line=>{
    // sehr einfacher Split – funktioniert, wenn deine CSV keine Kommas in Feldern enthält
    const cells = line.split(',');
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (cells[i] ?? '').trim());
    return obj;
  });
  return {headers, rows};
}

// ------- Download CSV aus aktuellen Daten -------
function toCSV(rows, headers){
  const esc = v => {
    if (v == null) return '';
    const s = String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  return [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
}
function download(name, content, mime='text/csv'){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
}

// ------- Sortieren -------
let currentSort = {key:null, dir:'asc'};
function sortRows(rows, key, dir){
  const mul = dir === 'desc' ? -1 : 1;
  return rows.slice().sort((a,b)=>{
    const av = a[key], bv = b[key];
    const na = parseFloat(av); const nb = parseFloat(bv);
    const bothNum = !Number.isNaN(na) && !Number.isNaN(nb);
    if (bothNum) return (na - nb) * mul;
    return String(av).localeCompare(String(bv)) * mul;
  });
}
function attachSortHandlers(headers, rows){
  Array.from(theadEl.children).forEach((th, idx)=>{
    const key = headers[idx];
    th.addEventListener('click', ()=>{
      const dir = (currentSort.key === key && currentSort.dir === 'asc') ? 'desc' : 'asc';
      currentSort = {key, dir};
      renderBody(sortRows(filterRows(rows), key, dir), headers);
      sortnoteEl.textContent = `sortiert nach ${key} (${dir})`;
      footEl.hidden = false;
    });
  });
}

// ------- Filter (Suche + optional questionIds) -------
function rowMatchesQuery(row, q){
  if (!q) return true;
  const s = q.toLowerCase();
  return Object.values(row).some(v => String(v ?? '').toLowerCase().includes(s));
}
function filterRows(rows){
  const q = searchEl.value.trim();
  let out = rows.filter(r => rowMatchesQuery(r, q));
  if (filterQuestionIds.length && 'question_id' in (rows[0]||{})){
    out = out.filter(r => filterQuestionIds.includes(String(r['question_id'])));
  }
  return out;
}

// ------- Render -------
function renderHead(headers){
  theadEl.innerHTML = '';
  headers.forEach(h=>{
    const th = document.createElement('th');
    th.textContent = h;
    theadEl.appendChild(th);
  });
}
function renderBody(rows, headers){
  tbodyEl.innerHTML = '';
  const limited = topN ? rows.slice(0, topN) : rows;
  limited.forEach(r=>{
    const tr = document.createElement('tr');
    headers.forEach(h=>{
      const td = document.createElement('td');
      const v = r[h];
      td.textContent = v == null ? '' : v;
      if (typeof v === 'number' || (!Number.isNaN(parseFloat(v)) && v !== '')) td.classList.add('num');
      tr.appendChild(td);
    });
    tbodyEl.appendChild(tr);
  });
  countEl.textContent = `${limited.length.toLocaleString()} Zeilen angezeigt` + (topN ? ` (Top ${topN})` : '');
}

// ------- Laden & Start -------
(async function init(){
  try{
    const t0 = performance.now();
    const res = await fetch(dataURL, {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.text();
    const isLikelyJSON = (typeParam==='json') || (/^\s*[\[{]/.test(raw) && typeParam!=='csv');

    let headers, rows;
    if (isLikelyJSON){
      const json = JSON.parse(raw);
      if (Array.isArray(json)){
        headers = Object.keys(json[0]||{});
        rows = json;
      } else if (Array.isArray(json.rows) && Array.isArray(json.columns)){
        headers = json.columns;
        rows = json.rows;
      } else {
        throw new Error('Unbekanntes JSON-Format. Erwartet Array von Objekten.');
      }
    } else {
      const parsed = parseCSV(raw);
      headers = parsed.headers;
      rows = parsed.rows;
    }

    // Spaltenauswahl/Sortierung aus Params
    if (columnsParam){
      const keep = columnsParam.split(',').map(s=>s.trim()).filter(Boolean);
      headers = keep;
      rows = rows.map(r=>{
        const o = {}; keep.forEach(k=> o[k] = r[k]); return o;
      });
    }

    // Initial sort
    if (sortParam){
      const [key,dir='asc'] = sortParam.split(':');
      currentSort = {key, dir};
      rows = sortRows(rows, key, dir);
      sortnoteEl.textContent = `sortiert nach ${key} (${dir})`;
      footEl.hidden = false;
    }

    // Render
    renderHead(headers);
    renderBody(filterRows(rows), headers);
    attachSortHandlers(headers, rows);
    tableEl.hidden = false;

    // Suche
    searchEl.addEventListener('input', ()=> {
      const base = currentSort.key ? sortRows(rows, currentSort.key, currentSort.dir) : rows;
      renderBody(filterRows(base), headers);
    });
    // Tastkürzel
    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault(); searchEl.focus(); searchEl.select();
      }
    });

    // Download
    dlBtn.addEventListener('click', ()=>{
      const base = currentSort.key ? sortRows(rows, currentSort.key, currentSort.dir) : rows;
      const filtered = filterRows(base);
      const csv = toCSV(filtered, headers);
      const fname = (titleParam || 'leaderboard').toLowerCase().replace(/\s+/g,'-') + '.csv';
      download(fname, csv, 'text/csv');
    });

    const ms = Math.round(performance.now()-t0);
    metaEl.textContent = `${rows.length.toLocaleString()} Zeilen • ${isLikelyJSON?'JSON':'CSV'} • ${ms} ms`;

    if (compact){
      document.documentElement.style.setProperty('--card','#0b111a');
      Array.from(document.querySelectorAll('.search, .btn')).forEach(el=>el.style.padding='6px 8px');
    }

    statusEl.textContent = '';
  } catch(err){
    console.error(err);
    statusEl.innerHTML = `<span class="err">Fehler:</span> ${err.message}`;
  }
})();
</script>
</body>
</html>
